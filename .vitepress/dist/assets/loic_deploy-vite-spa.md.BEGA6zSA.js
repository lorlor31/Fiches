import{_ as e,c as s,o as a,a2 as i}from"./chunks/framework.CEgrwLex.js";const g=JSON.parse('{"title":"Déployer une SPA Vite","description":"","frontmatter":{},"headers":[],"relativePath":"loic/deploy-vite-spa.md","filePath":"loic/deploy-vite-spa.md"}'),t={name:"loic/deploy-vite-spa.md"},n=i(`<h1 id="deployer-une-spa-vite" tabindex="-1">Déployer une SPA Vite <a class="header-anchor" href="#deployer-une-spa-vite" aria-label="Permalink to &quot;Déployer une SPA Vite&quot;">​</a></h1><blockquote><p>ℹ️ Tout au long de ce tutoriel, tu rencontreras des sections &quot;SPOILER&quot; que tu pourras déplier pour obtenir des explications sur ce que tu fais et pourquoi tu le fais.</p></blockquote><h2 id="etape-0-la-vm-server-kourou" tabindex="-1">Étape 0 : La VM Server Kourou <a class="header-anchor" href="#etape-0-la-vm-server-kourou" aria-label="Permalink to &quot;Étape 0 : La VM Server Kourou&quot;">​</a></h2><details><summary>SPOILER: C&#39;est quoi la VM Server Kourou ?</summary><p>Si tu dormais pendant la saison 8 du socle (ou si tu as beaucoup dormi depuis), voici un bref rappel de ce qu&#39;est la VM Server Kourou :</p><blockquote><p>O&#39;clock met à ta disposition un serveur virtuel dans le ☁️ cloud ☁️ pour t&#39;aider à t&#39;entraîner au déploiement de tes projets web et à l&#39;administration système. Ce serveur virtuel t&#39;est fourni avec un nom de domaine.</p></blockquote></details><p>😉 Rends-toi sur la page d&#39;administration de ta VM Server Kourou, tu en auras besoin pour la suite de ce tutoriel : <a href="https://kourou.oclock.io/ressources/vm-cloud/" target="_blank" rel="noreferrer">https://kourou.oclock.io/ressources/vm-cloud/</a></p><blockquote><p>ℹ️ Certaines commandes de ce tutoriel te demanderont le mot de passe administrateur de ta VM Server Kourou, tu trouveras celui-ci sur la page d&#39;administration.</p></blockquote><h3 id="initialiser-la-vm" tabindex="-1">Initialiser la VM <a class="header-anchor" href="#initialiser-la-vm" aria-label="Permalink to &quot;Initialiser la VM&quot;">​</a></h3><details><summary>SPOILER: Premiers pas</summary><p>Si tu n&#39;as jamais utilisé la VM Server Kourou ou si tu l&#39;as supprimée, clique sur le bouton &quot;Créer la VM&quot;.</p><p>Pour repartir d&#39;une VM vierge, clique sur le bouton &quot;Réinstaller la VM&quot;.</p><p>⚠️ Dans ces deux cas, tu devras créer une nouvelle clé SSH sur la VM Server Kourou pour pouvoir cloner et pull le projet depuis GitHub. Tu trouveras la procédure à suivre dans la <a href="https://kourou.oclock.io/ressources/fiche-recap/git-et-github/#cr%c3%a9er-une-cl%c3%a9-ssh-pour-github" target="_blank" rel="noreferrer">fiche récap dédiée à Git et GitHub</a>.</p></details><p>Si ta VM est déjà prête, clique sur &quot;Démarrer la VM&quot;.</p><h3 id="se-connecter-a-la-vm" tabindex="-1">Se connecter à la VM <a class="header-anchor" href="#se-connecter-a-la-vm" aria-label="Permalink to &quot;Se connecter à la VM&quot;">​</a></h3><p>Une fois la VM Server démarrée, connecte-toi en SSH. Tu trouveras la commande à utiliser dans ton terminal sur la page d&#39;administration de ta VM, elle devrait ressembler à ceci :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> student@pseudo-server.eddi.cloud</span></span></code></pre></div><p>⚠️ Tout le temps de ta connexion à la VM, <strong><em>ne ferme surtout pas la page d&#39;administration</em></strong> car c&#39;est elle qui permet d&#39;autoriser la connexion depuis ton IP !</p><h2 id="etape-1-installer-l-environnement-de-production" tabindex="-1">Étape 1 : Installer l&#39;environnement de production <a class="header-anchor" href="#etape-1-installer-l-environnement-de-production" aria-label="Permalink to &quot;Étape 1 : Installer l&#39;environnement de production&quot;">​</a></h2><p>Avoir un serveur, c&#39;est bien 👍, mais avoir un serveur capable de servir notre application, c&#39;est mieux 💯</p><details><summary>SPOILER: C&#39;est quoi, une app Vite ?</summary> En fin de compte, une SPA avec Vite, ce n&#39;est qu&#39;un ensemble de fichiers HTML, JavaScript, CSS et éventuellement des images. C&#39;est-à-dire : un site statique ! <p>Et pour servir un site statique, on n&#39;a besoin que d&#39;un serveur HTTP, comme Apache (c&#39;est un des plus utilisés).</p><p>Mais la particularité de React / Svelte, c&#39;est que le code doit être transpilé, c&#39;est-à-dire traduit, pour être utilisé par un navigateur. Les fichiers JSX et Svelte sont transpilés en JavaScript, SCSS et PostCSS transpilent vers CSS, etc. Et cette transpilation se fait au moyen de transpileurs souvent codés en JavaScript, nécessitant NodeJS pour pouvoir être exécutés dans un terminal.</p><p>Tu vas donc avoir besoin de Node et d&#39;un gestionnaire de dépendances pour générer les fichiers statiques de ton projet, c&#39;est ce qu&#39;on appelle la phase de &quot;build&quot; (🇬🇧 <em>build</em> = 🇫🇷 <em>construire</em>). Pour être cohérent avec la spé React, tu vas utiliser Yarn, mais tu pourrais très bien utiliser NPM par exemple, comme ce sera le cas si tu as suivi la spé i++.</p></details><h3 id="installation-de-node" tabindex="-1">Installation de Node <a class="header-anchor" href="#installation-de-node" aria-label="Permalink to &quot;Installation de Node&quot;">​</a></h3><blockquote><p>ℹ️ Tu vas installer Node sur ta VM Server Kourou avec <a href="https://github.com/nvm-sh/nvm" target="_blank" rel="noreferrer">Node Version Manager</a>, un outil qui permet d&#39;installer et d&#39;utiliser rapidement n&#39;importe quelle version de Node. Ainsi, tu t&#39;assures que tu exécuteras la version stable la plus récente de Node.</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bash</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.bashrc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nvm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --lts</span></span></code></pre></div><details><summary>SPOILER: Détail des commandes</summary><p>D&#39;abord, on télécharge le script d&#39;installation de NVM et on l&#39;exécute avec l&#39;interprète Bash (même programme qui interprète les commandes que tu entres dans ton terminal 😉). Ce script va télécharger NVM, l&#39;installer dans le répertoire personnel de l&#39;utilisateur actuel et ajouter l&#39;alias de commande <code>nvm</code> pour ce même utilisateur.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bash</span></span></code></pre></div><p>On dit à l&#39;interpréteur Bash du terminal de recharger le fichier <code>.bashrc</code> de l&#39;utilisateur, car celui-ci contient notamment l&#39;alias de commande <code>nvm</code> qu&#39;on va devoir utiliser ensuite. Sans ce rechargement, il faudrait se déconnecter et se reconnecter à la VM pour avoir accès à la commande <code>nvm</code>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.bashrc</span></span></code></pre></div><p>On utilise NVM pour installer la dernière version stable de Node et l&#39;utiliser. Une fois cette commande exécutée, tu peux vérifier la version de Node utilisée avec la commande <code>node --version</code>.</p><div class="language-bts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>nvm install --lts</span></span></code></pre></div></details><h3 id="installation-de-yarn-si-tu-utilises-yarn" tabindex="-1">Installation de Yarn (si tu utilises Yarn) <a class="header-anchor" href="#installation-de-yarn-si-tu-utilises-yarn" aria-label="Permalink to &quot;Installation de Yarn (si tu utilises Yarn)&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.yarnpkg.com/debian/pubkey.gpg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/sources.list.d/yarn.list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-install-recommends</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yarn</span></span></code></pre></div><details><summary>SPOILER: Détail des commandes</summary><p>Comme on veut installer Yarn depuis le dépôt (= catalogue de logiciels) officiel de Yarn, on doit ajouter les clés de sécurité et l&#39;URL de ce dépôt aux registres de catalogues et de clés du système d&#39;exploitation de la VM. Concrètement, ceci permettra d&#39;utiliser le gestionnaire de programmes de la VM pour installer Yarn. La première commande gère la clé de sécurité, la seconde ajoute le dépôt officiel de Yarn aux dépôts reconnus par la VM.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.yarnpkg.com/debian/pubkey.gpg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/sources.list.d/yarn.list</span></span></code></pre></div><p>Avant toute installation d&#39;un nouveau programme, on met à jour les informations des logiciels disponibles via le gestionnaire de logiciels <code>apt</code>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span></code></pre></div><p>On installe Yarn. Comme on a mis à jour la liste des logiciels disponibles après avoir ajouté le dépôt officiel, <code>apt</code> ira télécharger et installer Yarn depuis ce dernier. Ici, l&#39;option <code>-y</code> évite d&#39;avoir à confirmer manuellement l&#39;installation et l&#39;option <code>--noèinstall-recommends</code> fait en sorte que Node ne sera pas installé avec Yarn (c&#39;est ce qu&#39;on veut parce qu&#39;on a déjà installé Node avec NVM).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-install-recommends</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yarn</span></span></code></pre></div></details><h3 id="installation-d-apache" tabindex="-1">Installation d&#39;Apache <a class="header-anchor" href="#installation-d-apache" aria-label="Permalink to &quot;Installation d&#39;Apache&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2</span></span></code></pre></div><details><summary>SPOILER: Détail de la commande</summary><p>On installe le serveur HTTP Apache avec le gestionnaire de logiciels de la VM <code>apt</code>. Si tu avais déjà fait cette opération en saison 8, ne t&#39;en fais pas, cette commande ne fera rien, ou elle fera juste une mise à jour d&#39;Apache si une version plus récente est disponible.</p></details><h2 id="etape-2-recuperer-le-projet" tabindex="-1">Étape 2 : Récupérer le projet <a class="header-anchor" href="#etape-2-recuperer-le-projet" aria-label="Permalink to &quot;Étape 2 : Récupérer le projet&quot;">​</a></h2><h3 id="preparation-du-repo" tabindex="-1">Préparation du repo <a class="header-anchor" href="#preparation-du-repo" aria-label="Permalink to &quot;Préparation du repo&quot;">​</a></h3><p><strong>Depuis ta VM locale (Téléporteur / VM cloud)</strong> crée le fichier <code>public/.htaccess</code> dans ton projet et copie ce contenu à l&#39;intérieur :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>RewriteEngine on</span></span>
<span class="line"><span>RewriteCond %{REQUEST_FILENAME} !-f</span></span>
<span class="line"><span>RewriteRule ^.*$ index.html [QSA,L]</span></span></code></pre></div><p>Commit et push 📨 ce fichier, il est indispensable pour la suite !</p><details><summary>SPOILER: SPA, routing et réécriture d&#39;URL</summary><p>Dans une SPA avec, la navigation est la plupart du temps interceptée et gérée par un routeur (<code>react-router</code> dans le cas de React, ou le routeur propre au framework dans le cas de Svelte). Ça signifie que lorsqu&#39;un utilisateur change de page dans ton application, le changement d&#39;URL est contrôlé par ce routeur, qui empêche le chargement d&#39;une nouvelle page et remplace juste le contenu de la page actuelle.</p><p>Mais que se passe-t-il si on essaie d&#39;accéder directement à une autre URL que celle de la page d&#39;accueil de ton application ? Avec le serveur de développement de Vite, tout se passe bien, l&#39;application est bien initialisée et ce sont directement les composants de la page correspondant à l&#39;URL qui sont chargés. Cependant, ce ne sera pas le cas avec un serveur HTTP classique une fois qu&#39;on aura transformé ton application en site statique. En effet, le serveur ne saura pas qu&#39;il servira une SPA avec un routeur qui agit côté client (et, entre nous, le serveur, il s&#39;en fiche 🤷) ; on doit donc lui dire de toujours servir au client le fichier qui permet d&#39;initialiser la SPA et son routeur quand on lui demande une URL qui ne correspond à aucun fichier existant.</p><p>Dans le résultat du build, ce fichier, ce sera le fichier <code>index.html</code>. La configuration Apache ci-dessus indiquent, dans l&#39;ordre :</p><ul><li>d&#39;activer le moteur de réécriture d&#39;URL</li><li>que si l&#39;URL de la requête HTTP ne correspond à aucun fichier existant…</li><li>…alors il faut servir le contenu du fichier <code>index.html</code> (l&#39;option <code>QSA</code> permet de préserver les paramètres d&#39;URL, et l&#39;option <code>L</code> indique au moteur d&#39;URL d&#39;arrêter de chercher d&#39;autres règles de réécriture après celle-ci)</li></ul><p>En résumé, ce fichier <code>.htaccess</code> permet de faire en sorte que peu importe l&#39;URL par laquelle on accèdera à ton application, c&#39;est bien la SPA et le routeur côté client qui gèreront l&#39;affichage de la page, ou l&#39;erreur si jamais la page n&#39;existe pas.</p></details><blockquote><p>⚠️ Il est fortement conseillé de mettre tout le code à déployer sur la branche principale (<code>main</code> ou <code>master</code>) à ce stade, car c&#39;est elle qu&#39;on va utiliser pour le déploiement. En général, on fait ça avec une pull request.</p></blockquote><h3 id="clonage-du-repo" tabindex="-1">Clonage du repo <a class="header-anchor" href="#clonage-du-repo" aria-label="Permalink to &quot;Clonage du repo&quot;">​</a></h3><p><strong>De retour sur la VM Server Kourou</strong>, on récupère le code de l&#39;application (⚠️ <strong><em>pense à remplacer <code>&lt;URL&gt;</code> par l&#39;URL de clonage de ton repo !!!</em></strong>) :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> o+w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">UR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.site</span></span></code></pre></div><details><summary>SPOILER: Détail des commandes</summary><p>Par défaut, seul le superutilisateur <code>root</code> a le droit d&#39;écriture dans le répertoire <code>/var/www</code>. Or, tu es connecté à ta VM en tant que l&#39;utilisateur <code>student</code> (tu pensais pas qu&#39;on allait te donner tous les droits, hein ?😏), on modifie donc les droits d&#39;écriture pour que les &quot;autres&quot; utilisateurs comme <code>student</code> puissent modifier le contenu du répertoire.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> o+w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www</span></span></code></pre></div><p>Là, rien qu&#39;on ne connaît pas, on se place juste dans le répertoire <code>/var/www</code>. Pourquoi ce répertoire ? Parce que, par convention, c&#39;est le répertoire dans lequel on met les fichiers des sites qui peuvent être servis par un serveur web. On pourrait utiliser un autre répertoire, mais Apache a déjà configuré ses droits sur ce répertoire quand il a été installé.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www</span></span></code></pre></div><p>Là encore, la commande doit t&#39;être assez familière. La nouveauté ici, c&#39;est qu&#39;on utilise le deuxième paramètre de la commande <code>git clone</code> qui permet de spécifier le nom du répertoire dans lequel Git va cloner le repo. Tu peux utiliser celui qui te convient le mieux mais tu devras alors adapter les commandes et la configuration du virtual host dans ce qui suit. <strong><em>Pense bien à remplacer <code>&lt;URL&gt;</code> par l&#39;URL que tu utilises pour cloner ton repo.</em></strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">UR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.site</span></span></code></pre></div></details><blockquote><p>⚠️ Si Git n&#39;a pas accès au repo GitHub, assure-toi d&#39;avoir généré une clé SSH sur la VM Server Kourou et de l&#39;avoir enregistrée dans ton compte GitHub : <a href="https://kourou.oclock.io/ressources/fiche-recap/git-et-github/#cr%c3%a9er-une-cl%c3%a9-ssh-pour-github" target="_blank" rel="noreferrer">https://kourou.oclock.io/ressources/fiche-recap/git-et-github/#créer-une-clé-ssh-pour-github</a></p></blockquote><h3 id="build-du-projet-pour-la-production" tabindex="-1">Build du projet pour la production <a class="header-anchor" href="#build-du-projet-pour-la-production" aria-label="Permalink to &quot;Build du projet pour la production&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.site</span></span></code></pre></div><p>Si tu utilises <strong>NPM</strong> :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div><p>Si tu utilises <strong>Yarn</strong> :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div><details><summary>SPOILER: Détail des commandes</summary><p>Encore une fois, rien de très sorcier, on se place juste dans le répertoire dans lequel tu as cloné ton repo. Après cette commande, tu peux utiliser <code>git checkout</code> pour te mettre sur la branche ou le tag que tu souhaites déployer, si ce n&#39;est pas la branche principale.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.site</span></span></code></pre></div><p>On installe les dépendances du projet.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre></div><p><em>NOTE :</em> <code>yarn</code> fonctionne aussi à la place de <code>yarn install</code></p><p>Enfin, on lance le build du projet. Cette commande va transpiler tout ton code et ses dépendances en un ensemble de fichiers statiques dans le répertoire <code>dist/</code> à la racine de ton repo. Si tu regardes à l&#39;intérieur de ce répertoire, tu t&#39;apercevras que le fichier <code>.htaccess</code> y a également été copié (l&#39;original est toujours dans <code>public/</code>). Tu n&#39;as pas besoin de commit le contenu de <code>dist/</code>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div></details><h2 id="etape-3-configurer-le-virtual-host" tabindex="-1">Étape 3 : Configurer le <em>virtual host</em> <a class="header-anchor" href="#etape-3-configurer-le-virtual-host" aria-label="Permalink to &quot;Étape 3 : Configurer le _virtual host_&quot;">​</a></h2><h3 id="pointage-du-virtual-host-par-defaut-sur-le-repertoire-du-projet" tabindex="-1">Pointage du virtual host par défaut sur le répertoire du projet <a class="header-anchor" href="#pointage-du-virtual-host-par-defaut-sur-le-repertoire-du-projet" aria-label="Permalink to &quot;Pointage du virtual host par défaut sur le répertoire du projet&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s#\\/var\\/www\\/html#/var/www/app.site/dist\\n\\n\\t&lt;Directory /var/www/app.site/dist&gt;\\n\\t\\tAllowOverride all\\n\\t&lt;/Directory&gt;#g&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apache2/sites-available/000-default.conf</span></span></code></pre></div><details><summary>SPOILER: Détail de la commande</summary><p>J&#39;avoue, cette commande est carrément barbare 🧌 et, entre nous, franchement pas jolie 🫠</p><p>Il faut savoir que le serveur Apache peut gérer plusieurs sites à la fois sur une même machine. Pour ce faire, il utilise ce qu&#39;on appelle des &quot;virtual hosts&quot;, c&#39;est-à-dire qu&#39;il configure la manière dont il doit servir les fichiers des différents répertoires des sites concernés de manière atomique et isolée.</p><p>À l&#39;installation, Apache n&#39;a qu&#39;un virtual host configuré, qui est sont virtual host par défaut. Le fichier de configuration de ce virtual host est, pour la version Debian/Ubuntu d&#39;Apache, <code>/etc/apache2/sites-available/000-default.conf</code>. Si tu regardes le contenu de ce fichier avant d&#39;exécuter la commande donnée, tu remarqueras la ligne suivante :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>DocumentRoot /var/www/html</span></span></code></pre></div><p>Cette ligne indique que pour ce virtual host, Apache doit servir les fichiers qui se trouvent dans le répertoire <code>/var/www/html</code>. Dans ton cas, nous voulons servir les fichiers depuis le répertoire <code>dist/</code> créé précédemment par le build de ton application. La commande modifie donc cette ligne en :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>DocumentRoot /var/www/app.site/dist</span></span></code></pre></div><p>Mais ce n&#39;est pas tout ! Tu te souviens du fichier <code>.htaccess</code> ?</p><p>Il s&#39;agit d&#39;un fichier de configuration Apache qui permet de surcharger certaines parties de la configuration du serveur ou du virtual host. Par défaut, ce fichier n&#39;est pas pris en compte par Apache. La commande ajoute donc sa prise en charge en ajoutant aussi dans la configuration du virtual host ces lignes :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;Directory /var/www/app.site/dist&gt;</span></span>
<span class="line"><span>    AllowOverride all</span></span>
<span class="line"><span>&lt;/Directory&gt;</span></span></code></pre></div><p>Elles spécifient que dans le répertoire <code>/var/www/app.site/dist</code> et ses sous-répertoires, Apache doit tenir compte de toutes les directives de configuration qui se trouvent dans des fichiers <code>.htaccess</code>. Sans ça, notre <code>.htaccess</code> ne servirait à rien.</p><blockquote><p>❓<strong>Pourquoi utiliser un <code>.htaccess</code> au lieu de tout mettre dans la configuration du virtual host ?</strong></p><p>Le souci avec la configuration du virtual host, c&#39;est que pour des raisons de sécurité, les hébergeurs limitent souvent sa modification à quelques directives (le <code>DocumentRoot</code> la plupart du temps, et éventuellement quelques autres). En revanche, la plupart des directives de configuration courantes telles que la réécriture d&#39;URL sont généralement autorisées et prises en compte via les fichiers <code>.htaccess</code>. En embarquant la configuration du traitement des URL, propre à l&#39;application indépendamment du serveur sur lequel elle est déployée, plutôt que dans la configuration du virtual host, on s&#39;assure de sa portabilité.</p></blockquote></details><h3 id="activation-du-module-de-reecriture-d-url" tabindex="-1">Activation du module de réécriture d&#39;URL <a class="header-anchor" href="#activation-du-module-de-reecriture-d-url" aria-label="Permalink to &quot;Activation du module de réécriture d&#39;URL&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a2enmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rewrite</span></span></code></pre></div><details><summary>SPOILER: Détail de la commande</summary><p>Ici, on active le module de réécriture d&#39;URL d&#39;Apache. Celui-ci n&#39;est généralement pas activé par défaut sur une installation vierge, il faut donc l&#39;activer pour que nos règles de réécriture d&#39;URL soient prises en compte.</p><p>Si tu as déjà activé ce module, cette commande ne fera rien et t&#39;indiquera juste que le module est déjà activé. 🙂</p></details><h3 id="redemarrer-le-serveur-apache" tabindex="-1">Redémarrer le serveur Apache <a class="header-anchor" href="#redemarrer-le-serveur-apache" aria-label="Permalink to &quot;Redémarrer le serveur Apache&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2</span></span></code></pre></div><details><summary>SPOILER: Détail de la commande</summary><p>Le serveur Apache ne charge ses fichiers de configuration qu&#39;une seule fois, au démarrage. Comme tu viens de modifier un virtual host et d&#39;activer un de ses modules, tu dois redémarrer Apache pour qu&#39;il recharger sa configuration. Si tu n&#39;as pas introduit d&#39;erreur dans la configuration du virtual host, cette commande ne devrait produire aucun message.</p></details><h2 id="etape-4-contempler-son-oelig-uvre-🤩" tabindex="-1">Étape 4 : Contempler son œuvre 🤩 <a class="header-anchor" href="#etape-4-contempler-son-oelig-uvre-🤩" aria-label="Permalink to &quot;Étape 4 : Contempler son &amp;oelig;uvre 🤩&quot;">​</a></h2><p>Tu dois normalement pouvoir te rendre sur <code>http://&lt;pseudo&gt;-server.eddi.cloud</code> et voir ta SPA en production.</p><p>Alors, heureux·se ?</p><h2 id="etape-5-mettre-a-jour-l-application-en-production" tabindex="-1">Étape 5 : Mettre à jour l&#39;application en production <a class="header-anchor" href="#etape-5-mettre-a-jour-l-application-en-production" aria-label="Permalink to &quot;Étape 5 : Mettre à jour l&#39;application en production&quot;">​</a></h2><p>Pour mettre à jour la version de ton application en production, connecte-toi à ta VM Server Cloud, puis :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/app.site</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span></span></code></pre></div><p>Et enfin, si tu utilises <strong>NPM</strong> :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>npm install</span></span>
<span class="line"><span>npm run build</span></span></code></pre></div><p>Ou, si tu utilises <strong>Yarn</strong> :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>yarn install</span></span>
<span class="line"><span>yarn build</span></span></code></pre></div><details><summary>SPOILER: Détail des commandes</summary><p>Place-toi dans le répertoire dans lequel tu as cloné ton repo.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/app.site</span></span></code></pre></div><p>Mets à jour ton repo en récupérant les dernières modifications depuis GitHub avec un pull. Tu peux en profiter pour te placer sur une autre branche ou un autre tag avec <code>git checkout</code> si c&#39;est ce que tu veux déployer.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span></span></code></pre></div><p>Relance une installation des dépendances du projet pour t&#39;assurer d&#39;être bien à jour pour le build. C&#39;est surtout valable dans le cas où une nouvelle lib a été ajoutée au projet ou si une dépendance a été elle-même mise à jour dans le projet.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre></div><p>Lance un build de ton application pour regénérer le répertoire <code>dist/</code> (qui ne doit toujours pas être commit).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div></details>`,66),l=[n];function r(p,o,d,u,c,h){return a(),s("div",null,l)}const m=e(t,[["render",r]]);export{g as __pageData,m as default};
