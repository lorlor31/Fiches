import{_ as e,c as s,o as i,a2 as a}from"./chunks/framework.CEgrwLex.js";const g=JSON.parse('{"title":"Construire nos propres images Docker","description":"","frontmatter":{},"headers":[],"relativePath":"baptiste/09-dockerfile.md","filePath":"baptiste/09-dockerfile.md"}'),n={name:"baptiste/09-dockerfile.md"},t=a(`<h1 id="construire-nos-propres-images-docker" tabindex="-1">Construire nos propres images Docker <a class="header-anchor" href="#construire-nos-propres-images-docker" aria-label="Permalink to &quot;Construire nos propres images Docker&quot;">‚Äã</a></h1><p>On a vu qu&#39;on pouvait facilement d√©marrer un environnement de d√©veloppement PHP gr√¢ce √† Docker et l&#39;image officielle PHP, mais cet environnement n&#39;est pas complet : il nous manque par exemple le gestionnaire de d√©pendances Composer !</p><p>Pour rem√©dier √† cela, nous allons <strong>construire notre propre image Docker</strong> !</p><p>Nous allons nous baser sur l&#39;image officielle PHP et la &quot;personnaliser&quot; pour qu&#39;elle puisse h√©berger notre backend Laravel.</p><p>Pour construire une image Docker, on a besoin d&#39;un <strong>Dockerfile</strong>.</p><h2 id="dockerfile" tabindex="-1">Dockerfile <a class="header-anchor" href="#dockerfile" aria-label="Permalink to &quot;Dockerfile&quot;">‚Äã</a></h2><p>Le <strong>Dockerfile</strong> est un fichier propre √† Docker, qui permet de cr√©er nos propres images Docker personnalis√©es √† partir d&#39;images existantes.</p><p>‚ö†Ô∏è Attention, ce fichier <strong>doit s&#39;appeller Dockerfile</strong>, sans extension et avec un <code>D</code> majuscule.</p><p>Sa syntaxe est sp√©cifique √† Docker, on y d√©crit plusieurs instructions qui seront trait√©es une par une.</p><p>Une partie des instructions disponibles (les plus utiles) :</p><ul><li><code>FROM &lt;image&gt;</code> : en g√©n√©ral la premi√®re instruction, permet d&#39;indiquer <strong>√† partir de quelle image on veut construire la notre</strong>.</li><li><code>RUN &lt;command&gt;</code> : permet de lancer une commande dans le conteneur, un peu comme <code>docker exec</code> !</li><li><code>CMD &lt;command&gt;</code> : permet de lancer une commande <strong>au d√©marrage du conteneur</strong>. Cette instruction ne doit √™tre pr√©sente qu&#39;une seule fois, et peut servir par exemple √† d√©marrer notre application si n√©cessaire.</li><li><code>LABEL &lt;key&gt;:&lt;value&gt;</code> : permet d&#39;ajouter des m√©tadonn√©es √† notre image, √† titre informatif.</li><li><code>EXPOSE &lt;port&gt;</code> : informe Docker que notre image va √©couter sur un port sp√©cifique. Cette instruction ne redirige pas le port pour autant, cette instruction sert √† documenter notre image.</li><li><code>ENV &lt;key&gt;=&lt;value&gt;</code> : permet de d√©finir une variable d&#39;environnement <code>&lt;key&gt;</code> et lui donner la valeur <code>&lt;value&gt;</code>.</li><li><code>COPY &lt;source&gt; &lt;destination&gt;</code> : permet de copier des fichiers de l&#39;h√¥te √† l&#39;int√©rieur du conteneur.</li><li><code>WORKDIR /chemin/vers/workdir</code> : permet de se d√©placer dans un dossier √† l&#39;int√©rieur du conteneur, utilis√© souvent avant de lancer des commandes avec <code>RUN</code>.</li></ul><h3 id="creer-un-dockerfile-pour-laravel" tabindex="-1">Cr√©er un Dockerfile pour Laravel <a class="header-anchor" href="#creer-un-dockerfile-pour-laravel" aria-label="Permalink to &quot;Cr√©er un Dockerfile pour Laravel&quot;">‚Äã</a></h3><p>Pour notre backend Laravel, on peux utiliser le <code>Dockerfile</code> suivant :</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># on part de l&#39;image PHP 8.1 avec Apache</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> php:8.1-apache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># En suivant les instructions de la doc sur le Dockerhub, on active l&#39;extention PHP pdo_mysql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> docker-php-ext-install pdo_mysql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Toujours en suivant la doc, on installe l&#39;utilitaire pour d√©zipper &amp; l&#39;extention PHP zip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apt update</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apt install -y libzip-dev zip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> docker-php-ext-install zip</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On se place dans le dossier /var/www/html</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /var/www/html</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Et on copie le contenu du dossier courant (.) √† l&#39;int√©rieur de l&#39;h√¥te (dossier back)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># dans le dossier courant √† l&#39;int√©rieur de l&#39;image (dossier /var/www/html)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> . .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Toujours en suivant la doc, on r√©cup√®re Composer depuis une image Docker officielle</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># et on on le copie dans notre image (√† l&#39;emplacement /usr/bin/composer)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=composer:latest /usr/bin/composer /usr/bin/composer</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On lance la commande \`cp .env.example .env\` √† l&#39;int√©rieur de l&#39;image</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cp .env.example .env</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Puis on lance la commande \`composer install\` pour installer les d√©pendances</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> composer install --no-interaction --optimize-autoloader</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On lance la commande \`php artisan key:generate\`, n√©cessaire au bon fonctionnement de Laravel</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> php artisan key:generate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On ajoute les droits d&#39;√©criture √† tout le monde sur le dossier /var/www/html/storage, pour que Laravel puisse √©crire ses logs et son cache</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chmod -R a+w /var/www/html/storage</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On modifie le DocumentRoot du virtual host par d√©faut d&#39;apache, toujours en suivant la doc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> APACHE_DOCUMENT_ROOT /var/www/html/public</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sed -ri -e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;s!/var/www/html!\${APACHE_DOCUMENT_ROOT}!g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /etc/apache2/sites-available/*.conf</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sed -ri -e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;s!/var/www/!\${APACHE_DOCUMENT_ROOT}!g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Et pour finir on permet √† Apache de lire les fichiers .htaccess et on active la r√©ecriture d&#39;URL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/&lt;Directory </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">var</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">www</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&gt;/,/&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Directory&gt;/ s/AllowOverride None/AllowOverride all/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /etc/apache2/apache2.conf</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a2enmod rewrite</span></span></code></pre></div><p>üí° On doit placer ce fichier √† l&#39;int√©rieur de notre dossier <code>back</code>, il est d√©j√† pr√©sent.</p><h2 id="docker-build" tabindex="-1">Docker build <a class="header-anchor" href="#docker-build" aria-label="Permalink to &quot;Docker build&quot;">‚Äã</a></h2><p>Une fois notre <code>Dockerfile</code> pr√™t, on va pouvoir demander √† Docker de construire notre image. Pour cela, on utilise la commande <code>docker build</code> :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> back</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pomodoro-backend-laravel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><p>üí° L&#39;argument <code>-t pomodoro-backend-laravel</code> nous permet de <strong>donner un nom √† notre image</strong>.</p><p>Observez le terminal : on peut y voir toutes les commandes qu&#39;on a mis dans le <code>Dockerfile</code> √™tre lanc√©es une par une ! √Ä la fin, Docker va nous indiquer :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> built</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1f5d64344316</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tagged</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pomodoro-backend-laravel:latest</span></span></code></pre></div><p>Ce message nous indique que notre image a √©t√© construite avec succ√®s, et a √©t√© <em>tagg√©e</em> (= nomm√©e) <code>pomodoro-backend-laravel:latest</code>.</p><p>Par d√©faut, notre image a le tag <code>latest</code>, mais on peut sp√©cifier le tag souhait√© pour cr√©er diff√©rentes versions de notre image (exemple : <code>docker build -t pomodoro-backend-laravel:experimental</code>).</p><p>On peut maintenant d√©marrer un conteneur √† partir de notre nouvelle image :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -dp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8080:80</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pomodoro-backend-laravel</span></span></code></pre></div><p>Ouvrez votre navigateur √† l&#39;adresse <a href="http://localhost:8080" target="_blank" rel="noreferrer">http://localhost:8080</a>, vous devriez voir la documentation de notre API üéâ</p><p>Essayez ensuite l&#39;URL <a href="http://localhost:8080/api/tasks" target="_blank" rel="noreferrer">http://localhost:8080/api/tasks</a>. On a une erreur Laravel : <code>SQLSTATE[HY000] [2002] Connection refused</code>. Une petite id√©e d&#39;o√π peut venir cette erreur ?</p><details><summary>Solution</summary><p>On a oubli√© de configurer notre base de donn√©es dans le fichier <code>.env</code> !</p><blockquote><p>Mais on fait comment, on a pas install√© MySQL ? Ni charg√© notre fichier <code>DB.sql</code> !</p></blockquote><p>On verra √ßa par la suite üòâ</p></details><h2 id="docker-push" tabindex="-1">Docker push <a class="header-anchor" href="#docker-push" aria-label="Permalink to &quot;Docker push&quot;">‚Äã</a></h2><p>Pour l&#39;instant, l&#39;image qu&#39;on vient de cr√©er (on dit aussi parfois <strong>compiler</strong>) n&#39;est disponible que sur notre h√¥te. Comment faire si on veut la d√©ployer sur un serveur de production ?</p><p>On va publier notre image sur le <strong>DockerHub</strong> !</p><p>On utilise pour cela la commande <code>docker push</code>, mais on doit au pr√©alable se connecter :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> login</span></span></code></pre></div><p>Saisissez vos identifiants DockerHub quand ils vous sont demand√©s.</p><p>Rendez-vous ensuite sur le <a href="https://hub.docker.com/" target="_blank" rel="noreferrer">DockerHub</a>, connectez-vous si n√©cessaire, et cliquez sur le bouton <code>Create repository</code>. Comme nom, saisissez <code>pomodoro-backend-laravel</code>, et choisissez la visibilit√© publique.</p><p>Pour indiquer √† Docker quelle image il faut publier, on doit <strong>tagger</strong> notre image avec notre nom d&#39;utilisateur :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> image</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pomodoro-backend-laravel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PSEUDO-DH/pomodoro-backend-laravel:latest</span></span></code></pre></div><p>üí° N&#39;oubliez pas de remplacer <code>PSEUDO-DH</code> par votre nom d&#39;utilisateur DockerHub !</p><p>On peut ensuite publier notre image avec la commande :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PSEUDO-DH/pomodoro-backend-laravel:latest</span></span></code></pre></div><p>Une fois l&#39;image publi√©e, on pourra l&#39;utiliser sur n&#39;importe quelle machine sur laquelle Docker est install√© avec la commande :</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -dp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8080:80</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PSEUDO-DH/pomodoro-backend-laravel</span></span></code></pre></div><p>On s&#39;occupera du d√©ploiement sur notre serveur de production par la suite, mais avant, et si on regardait comment mettre en place la base de donn√©es ?</p><p>Pour cela, on va d√©couvrir comment faire fonctionner des <strong>applications multi-conteneurs avec Docker Compose</strong> ! √áa se passe par <a href="./10-docker-compose.html">ici</a>.</p>`,44),l=[t];function r(p,o,d,c,h,k){return i(),s("div",null,l)}const m=e(n,[["render",r]]);export{g as __pageData,m as default};
